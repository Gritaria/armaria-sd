<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Black Berets - Armas e Munições</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Special+Elite&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              western: ['Rye', 'serif'],
              typewriter: ['Special Elite', 'monospace'],
              ledger: ['Courier Prime', 'monospace'],
            },
            colors: {
              gun: {
                metal: '#2c3e50',
                barrel: '#1a1c20',
                brass: '#b59b56',
                wood: '#5d4037',
                paper: '#d8cba8',
                paperDark: '#c4b694',
                blood: '#660000',
                blueprint: '#1e3a5f',
                blueprintLine: '#4a6fa5',
              }
            },
            backgroundImage: {
              'checker-pattern': "url(\"data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%231a1c20' fill-opacity='0.05' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E\")",
            }
          }
        }
      }
    </script>

    <style>
      body { background-color: #0f1115; color: #d8cba8; }
      
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #1a1c20; }
      ::-webkit-scrollbar-thumb { background: #b59b56; border-radius: 2px; border: 1px solid #1a1c20; }
      
      .grunge-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.07'/%3E%3C/svg%3E");
        z-index: 50;
      }
      
      .receipt-paper {
        background: #d8cba8;
        background-image: repeating-linear-gradient(#d8cba8 0px, #d8cba8 24px, #c4b694 25px);
        box-shadow: 10px 10px 20px rgba(0,0,0,0.7);
      }

      .blueprint-paper {
        background-color: #1e3a5f;
        background-image: 
            linear-gradient(rgba(74, 111, 165, 0.2) 1px, transparent 1px),
            linear-gradient(90deg, rgba(74, 111, 165, 0.2) 1px, transparent 1px);
        background-size: 20px 20px;
        box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
      }

      input[type=number]::-webkit-inner-spin-button, 
      input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
      
      .dashed-box { border: 2px dashed rgba(181, 155, 86, 0.3); }
      
      .icon-btn.selected { background-color: #2c3e50; color: #b59b56; transform: scale(1.1); border-color: #b59b56; }
      .color-btn.selected { border-color: #d8cba8; transform: scale(1.2); box-shadow: 0 0 10px rgba(181, 155, 86, 0.5); }
      
      .service-btn.active {
        background-color: #2c3e50;
        color: #b59b56;
        border-color: #b59b56;
        box-shadow: 2px 2px 0px 0px rgba(0, 0, 0, 0.8);
        transform: translateY(-2px);
      }

      .input-readable {
        background-color: rgba(216, 203, 168, 0.1);
        color: #d8cba8;
        font-weight: 700;
        border: 1px solid rgba(181, 155, 86, 0.3);
      }
      .input-readable:focus {
        border-color: #b59b56;
        background-color: rgba(216, 203, 168, 0.2);
        outline: none;
      }
      .input-readable::placeholder {
        color: rgba(216, 203, 168, 0.3);
        font-weight: normal;
      }
      
      .wood-grain {
         background: repeating-linear-gradient(45deg, #2b1d16, #2b1d16 10px, #241812 10px, #241812 20px);
      }
    </style>
</head>
<body class="font-sans pb-10 overflow-x-hidden flex flex-col min-h-screen bg-checker-pattern">

    <div class="grunge-overlay"></div>

    <header class="bg-gun-barrel text-gun-paper py-6 shadow-2xl border-b-4 border-gun-brass relative z-20 shrink-0 wood-grain">
        <div class="container mx-auto px-4 flex justify-center items-center relative min-h-[5rem]">
            <div class="absolute top-2 left-2 w-3 h-3 rounded-full bg-gun-brass shadow-inner opacity-70"></div>
            <div class="absolute top-2 right-2 w-3 h-3 rounded-full bg-gun-brass shadow-inner opacity-70"></div>
            <div class="absolute bottom-2 left-2 w-3 h-3 rounded-full bg-gun-brass shadow-inner opacity-70"></div>
            <div class="absolute bottom-2 right-2 w-3 h-3 rounded-full bg-gun-brass shadow-inner opacity-70"></div>

            <!-- Left Side: Logo (Absolute) -->
            <div class="absolute left-4 top-1/2 -translate-y-1/2">
                <div class="h-20 w-20 rounded border-4 border-gun-brass/30 bg-gun-metal flex items-center justify-center overflow-hidden shrink-0 shadow-[inset_0_2px_10px_rgba(0,0,0,0.8)] hidden transition-all" id="headerLogoContainer">
                   <!-- Logo container empty by default -->
                </div>
            </div>

            <!-- Center: Title Text -->
            <div class="text-center z-10">
                <h1 id="headerStoreName" class="font-western text-3xl md:text-5xl tracking-[0.2em] drop-shadow-lg text-gun-paper bg-clip-text text-center">BLACK BERETS</h1>
                <div class="flex items-center gap-2 mt-1 justify-center">
                    <div class="h-[1px] bg-gun-brass w-8 sm:w-12"></div>
                    <p class="font-typewriter text-xs text-gun-brass/80 tracking-widest uppercase block">Armas e Munições</p>
                    <div class="h-[1px] bg-gun-brass w-8 sm:w-12"></div>
                </div>
            </div>
            
            <!-- Right Side: Buttons (Absolute) -->
            <div class="absolute right-4 top-1/2 -translate-y-1/2 flex items-center gap-2 sm:gap-4">
                <button onclick="toggleWorkshop()" class="p-3 hover:bg-gun-brass/10 rounded-full transition-colors group border border-transparent hover:border-gun-brass/30" title="Oficina de Manufatura">
                    <i data-lucide="anvil" class="w-8 h-8 text-gun-brass group-hover:-translate-y-1 transition-transform duration-300"></i>
                </button>
                <button onclick="toggleSettings()" class="p-3 hover:bg-gun-brass/10 rounded-full transition-colors group border border-transparent hover:border-gun-brass/30" title="Configurações">
                    <i data-lucide="settings" class="w-8 h-8 text-gun-brass group-hover:rotate-90 transition-transform duration-700"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-7xl flex-grow flex flex-col lg:flex-row gap-8 relative z-10">
            
        <!-- Product Catalog -->
        <div class="lg:w-2/3 flex flex-col gap-6 h-full">
            <div class="overflow-y-auto custom-scrollbar pr-2 flex-grow min-h-[500px]" id="productsGrid">
                <div class="text-center py-20 opacity-30">
                    <i data-lucide="hammer" class="w-12 h-12 animate-bounce mx-auto mb-4 text-gun-brass"></i>
                    <p class="font-western text-gun-paper">Polindo o aço...</p>
                </div>
            </div>

            <!-- Services / Maintenance Panel -->
            <div class="bg-gun-barrel border border-gun-brass/30 p-5 shadow-2xl rounded relative overflow-hidden shrink-0">
                <div class="absolute top-0 right-0 p-2 opacity-5">
                    <i data-lucide="wrench" class="w-24 h-24"></i>
                </div>
                
                <div class="flex items-center gap-2 mb-4 border-b border-gun-brass/20 pb-2 relative z-10">
                    <div class="p-1 rounded bg-gun-metal border border-gun-brass/40">
                         <i data-lucide="sparkles" class="w-4 h-4 text-gun-brass"></i>
                    </div>
                    <h3 class="font-western text-lg text-gun-paper tracking-wide">Personalização (Peças)</h3>
                </div>
                
                <div class="flex flex-col md:flex-row gap-4 items-end relative z-10">
                    <div class="flex-1 w-full relative group">
                         <label class="text-[10px] font-typewriter text-gun-brass/60 uppercase mb-1 block">Valor da Customização</label>
                         <div class="relative">
                             <div class="absolute left-0 top-1/2 -translate-y-1/2 text-gun-brass/50 pl-3">
                                 <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                             </div>
                             <input type="number" id="customizationInput" placeholder="0.00"
                             class="w-full bg-black/40 border border-gun-brass/30 pl-10 pr-2 py-2 font-typewriter text-gun-brass focus:outline-none focus:border-gun-brass focus:bg-black/60 transition-colors rounded text-lg">
                         </div>
                    </div>
                    <button onclick="addCustomization()" class="bg-gun-metal text-gun-brass border border-gun-brass/50 hover:bg-gun-brass hover:text-black font-western uppercase py-2 px-4 rounded shadow-lg transition-all h-[42px] flex items-center gap-2 whitespace-nowrap">
                        <i data-lucide="plus-circle" class="w-5 h-5"></i> Adicionar
                    </button>
                </div>
                <p class="text-[10px] text-gun-paper/40 font-typewriter mt-2 italic">* A taxa de serviço (Mão de Obra) de 30% será aplicada automaticamente sobre este valor.</p>
            </div>
        </div>

        <!-- Receipt / Ledger -->
        <div class="lg:w-1/3 h-auto lg:h-full sticky top-4 lg:static">
            <div id="receiptArea" class="receipt-paper text-gray-900 p-1 font-ledger text-sm relative min-h-[600px] flex flex-col border-[6px] border-double border-gray-800 shadow-2xl transform rotate-[0.5deg]">
                
                <!-- Inner Receipt Padding -->
                <div class="border border-dashed border-gray-600/50 h-full flex flex-col p-5">

                    <div id="receiptWatermark" class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-[0.03] hidden overflow-hidden z-0">
                        <img src="" class="w-3/4 object-contain grayscale contrast-150">
                    </div>

                    <div class="relative z-10 flex flex-col h-full">
                        <div class="text-center border-b-2 border-gray-800 pb-4 mb-4">
                            <div class="flex flex-col items-center justify-center gap-2 mb-2">
                                <img id="receiptLogo" src="" class="h-14 w-auto max-w-[100px] object-contain grayscale contrast-125 hidden mix-blend-multiply">
                                <h2 id="receiptStoreTitle" class="font-western text-2xl uppercase tracking-widest leading-none break-words scale-y-110">BLACK BERETS</h2>
                            </div>
                            <p class="text-[10px] uppercase mt-1 font-typewriter tracking-[0.2em] text-gray-700" id="receiptAddressDate">New Hanover, The Heartlands</p>
                            <div class="w-full h-px bg-gray-800 mt-2"></div>
                            <div class="w-full h-px bg-gray-800 mt-1"></div>
                        </div>

                        <div class="flex-grow overflow-y-auto custom-scrollbar pr-1 max-h-[50vh]" id="cartItems">
                            <div class="flex flex-col items-center justify-center h-40 text-gray-500/50 italic font-western">
                                <span>A bancada está vazia...</span>
                            </div>
                        </div>

                        <div class="mt-auto border-t-2 border-gray-800 pt-4 relative">
                            <!-- Stamp effect -->
                            <div class="absolute -top-6 right-2 transform rotate-12 border-2 border-red-800 text-red-800 px-2 py-1 font-western text-xs opacity-60 pointer-events-none">
                                PAGO
                            </div>

                            <div class="space-y-1 mb-4 px-1">
                                <div class="flex justify-between font-typewriter text-sm text-gray-700">
                                    <span>SUBTOTAL:</span>
                                    <span id="subtotalDisplay" class="font-bold">$0.00</span>
                                </div>
                                <div class="flex justify-between font-typewriter text-sm text-gray-700 items-center">
                                    <span id="serviceLabel" class="italic">SERVIÇOS:</span>
                                    <span id="serviceDisplay" class="font-bold">$0.00</span>
                                </div>
                            </div>

                            <div class="flex justify-between items-end font-western text-2xl text-gray-900 pt-2 border-t border-dashed border-gray-600">
                                <span>TOTAL:</span>
                                <span id="totalDisplay" class="text-3xl font-ledger font-bold underline decoration-double decoration-gray-400">$0.00</span>
                            </div>
                            
                            <!-- Footer phrases removed -->
                        </div>

                        <div class="grid grid-cols-3 gap-3 mt-4" data-html2canvas-ignore="true">
                            <button onclick="clearCart()" class="col-span-1 border border-gray-800 text-gray-800 hover:bg-red-900/10 font-western text-xs py-3 uppercase tracking-wider transition-colors" title="Limpar Bancada">
                                Limpar
                            </button>
                            <button onclick="downloadReceipt()" class="col-span-2 bg-gray-900 text-gun-paper border border-black hover:bg-black font-western text-sm py-3 uppercase flex justify-center items-center gap-2 shadow-lg hover:translate-y-[1px] transition-all">
                                <i data-lucide="feather" class="w-4 h-4"></i> Emitir Recibo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity opacity-0 pointer-events-none">
        <div class="bg-gun-barrel w-full max-w-2xl h-[90vh] max-h-[800px] flex flex-col border-2 border-gun-brass relative overflow-hidden transform scale-95 transition-transform shadow-[0_0_50px_rgba(0,0,0,1)]" id="settingsModalContent">
            
            <div class="bg-gun-metal p-4 flex justify-between items-center text-gun-brass border-b border-gun-brass/20 shrink-0">
                <div class="flex items-center gap-3">
                    <i data-lucide="cog" class="w-6 h-6 animate-spin-slow"></i>
                    <h2 class="font-western text-2xl tracking-widest">REGISTRO DA LOJA</h2>
                </div>
                <button onclick="toggleSettings()" class="hover:text-white transition-colors"><i data-lucide="x" class="w-8 h-8"></i></button>
            </div>

            <div class="flex border-b border-gun-brass/10 bg-black/20 shrink-0">
                <button onclick="switchTab('general')" id="tab-general" class="flex-1 py-4 font-western text-lg transition-colors bg-gun-barrel text-gun-brass border-r border-gun-brass/10">DADOS DA ARMARIA</button>
                <button onclick="switchTab('products')" id="tab-products" class="flex-1 py-4 font-western text-lg transition-colors text-gun-paper/40 hover:bg-gun-brass/5 hover:text-gun-brass">INVENTÁRIO (<span id="prodCount">0</span>)</button>
            </div>
            
            <div class="overflow-y-auto p-6 md:p-8 space-y-6 custom-scrollbar flex-grow bg-gun-barrel relative">
                <!-- Gun Blueprint Background -->
                <div class="absolute inset-0 pointer-events-none opacity-5 bg-[url('https://www.transparenttextures.com/patterns/blueprint.png')] z-0"></div>
                
                <div id="content-general" class="space-y-8 relative z-10">
                    <div class="space-y-2">
                        <label class="font-western text-lg text-gun-brass">Nome do Estabelecimento</label>
                        <input type="text" id="confStoreName" class="w-full input-readable rounded p-2 font-typewriter text-xl bg-black/30 border-gun-brass/40 text-gun-paper">
                    </div>

                    <div class="space-y-2">
                        <label class="font-western text-lg text-gun-brass">Localização</label>
                        <input type="text" id="confStoreAddress" placeholder="Ex: Valentine, New Hanover" class="w-full input-readable rounded p-2 font-typewriter text-lg bg-black/30 border-gun-brass/40 text-gun-paper">
                    </div>

                    <div class="pt-4 border-t border-dashed border-gun-brass/20">
                        <label class="font-western text-lg text-gun-brass mb-4 block">Marca / Brasão</label>
                        <div class="flex flex-col sm:flex-row gap-6 items-start">
                            <div class="w-32 h-32 border-2 border-gun-brass/30 bg-black/40 flex items-center justify-center relative group rounded overflow-hidden shadow-inner">
                                <img id="confLogoPreview" class="w-full h-full object-contain hidden p-2">
                                <div id="confLogoPlaceholder" class="flex flex-col items-center opacity-30 text-gun-brass">
                                    <i data-lucide="image" class="w-8 h-8 mb-1"></i>
                                </div>
                                <button onclick="removeLogo()" class="absolute inset-0 bg-red-900/80 text-white opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                                    <i data-lucide="trash-2"></i>
                                </button>
                            </div>
                            
                            <div class="flex-1 space-y-4">
                                <input type="file" id="logoInput" accept="image/*" onchange="handleLogoUpload(this)" class="hidden">
                                <button onclick="document.getElementById('logoInput').click()" class="bg-gun-metal text-gun-brass px-4 py-2 font-typewriter text-sm rounded hover:bg-gun-brass hover:text-black flex items-center gap-2 border border-gun-brass/50 shadow-sm transition-all uppercase">
                                    <i data-lucide="upload" class="w-4 h-4"></i> Carregar Imagem
                                </button>
                                
                                <div class="space-y-2 pt-1">
                                    <label class="flex items-center gap-3 text-sm font-typewriter cursor-pointer select-none text-gun-paper hover:text-gun-brass transition-colors">
                                        <input type="checkbox" id="confShowHeader" class="accent-gun-brass w-4 h-4 bg-transparent"> 
                                        <span>Exibir no letreiro</span>
                                    </label>
                                    <label class="flex items-center gap-3 text-sm font-typewriter cursor-pointer select-none text-gun-paper hover:text-gun-brass transition-colors">
                                        <input type="checkbox" id="confShowWatermark" class="accent-gun-brass w-4 h-4 bg-transparent"> 
                                        <span>Usar como Marca D'água (Recibo)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8 pt-6 border-t border-gun-brass/20">
                        <div class="dashed-box p-4 rounded bg-gun-brass/5 border-gun-brass/20">
                            <h3 class="font-western text-lg mb-3 text-gun-brass">Livros Contábeis</h3>
                            <div class="flex flex-col gap-3">
                                <button onclick="importSettingsClick()" class="flex items-center gap-2 text-sm font-typewriter text-gun-paper hover:text-gun-brass transition-colors group">
                                    <i data-lucide="file-up" class="w-4 h-4 group-hover:-translate-y-0.5 transition-transform"></i> Importar Inventário
                                </button>
                                <button onclick="exportSettings()" class="flex items-center gap-2 text-sm font-typewriter text-gun-paper hover:text-gun-brass transition-colors group">
                                    <i data-lucide="download" class="w-4 h-4 group-hover:translate-y-0.5 transition-transform"></i> Exportar Inventário
                                </button>
                                <input type="file" id="importInput" accept=".json" class="hidden" onchange="importSettings(this)">
                            </div>
                        </div>

                        <div class="dashed-box p-4 rounded bg-red-900/10 border-red-900/30 flex flex-col justify-between">
                             <h3 class="font-western text-lg mb-3 text-gun-blood">Zona de Perigo</h3>
                             <button onclick="resetFactory()" class="text-red-500 font-typewriter text-sm font-bold flex items-center gap-2 hover:underline">
                                <i data-lucide="flame" class="w-4 h-4"></i> Queimar Tudo (Reset)
                             </button>
                        </div>
                    </div>
                </div>

                <div id="content-products" class="hidden space-y-8 relative z-10">
                    <div class="bg-black/30 p-5 border border-gun-brass/20 rounded shadow-inner space-y-5">
                        <h3 class="font-western text-xl text-gun-brass">Adicionar Arma / Munição</h3>
                        <div class="grid grid-cols-12 gap-3">
                            <div class="col-span-12 sm:col-span-5">
                                <input type="text" id="newProdName" placeholder="Nome do Item (Ex: Winchester)" class="w-full input-readable rounded p-2 font-typewriter shadow-sm bg-black/40 text-gun-paper border-gun-brass/30">
                            </div>
                            <div class="col-span-6 sm:col-span-3">
                                <div class="relative">
                                    <span class="absolute left-2 top-1/2 -translate-y-1/2 font-typewriter opacity-50 z-10 text-gun-brass">$</span>
                                    <input type="number" id="newProdPriceMax" placeholder="Preço Máx" class="w-full input-readable rounded p-2 pl-6 font-typewriter shadow-sm bg-black/40 text-gun-paper border-gun-brass/30">
                                </div>
                            </div>
                            <div class="col-span-6 sm:col-span-4">
                                <select id="newProdCat" class="w-full input-readable rounded p-2 font-typewriter h-full shadow-sm cursor-pointer bg-black/40 text-gun-paper border-gun-brass/30">
                                    <option value="Revólveres">Revólveres</option>
                                    <option value="Rifles">Rifles & Repetição</option>
                                    <option value="Pistolas">Pistolas</option>
                                    <option value="Munição">Munição</option>
                                    <option value="Outros">Outros</option>
                                </select>
                            </div>
                        </div>

                        <div class="dashed-box p-3 rounded bg-gun-metal/50 border-gun-brass/20">
                            <label class="text-xs font-western text-gun-brass/70 uppercase mb-2 block tracking-widest">Escolha o Ícone</label>
                            <div class="flex flex-wrap gap-3" id="iconPickerGrid"></div>
                        </div>

                        <div class="dashed-box p-3 rounded bg-gun-metal/50 border-gun-brass/20">
                            <label class="text-xs font-western text-gun-brass/70 uppercase mb-2 block tracking-widest">Acabamento (Cor)</label>
                            <div class="flex gap-3 flex-wrap" id="colorPickerGrid"></div>
                        </div>

                        <button onclick="addProduct()" class="w-full bg-gun-brass text-black py-3 font-western uppercase rounded hover:bg-yellow-600 transition-all flex items-center justify-center gap-2 text-lg shadow-md active:translate-y-0.5">
                            <i data-lucide="plus"></i> Adicionar ao Estoque
                        </button>
                    </div>

                    <div class="space-y-3 pb-4" id="confProductList"></div>
                </div>
            </div>

            <div class="p-4 bg-gun-metal border-t border-gun-brass/30 shrink-0 flex justify-end gap-3 z-20 relative">
                 <button onclick="toggleSettings()" class="px-6 py-2 font-western text-gun-brass border border-transparent hover:border-gun-brass/30 rounded transition-colors uppercase">Cancelar</button>
                 <button onclick="saveSettings()" class="bg-gun-brass text-black px-8 py-2 font-western uppercase rounded shadow-lg hover:bg-yellow-600 flex items-center gap-2 hover:scale-105 transition-transform">
                    <i data-lucide="save" class="w-4 h-4"></i> Salvar
                 </button>
            </div>
        </div>
    </div>

    <!-- WORKSHOP MODAL (Crafting Calculator) -->
    <div id="workshopModal" class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity opacity-0 pointer-events-none">
        <div class="bg-gun-barrel w-full max-w-5xl h-[90vh] flex flex-col border-2 border-gun-brass relative overflow-hidden transform scale-95 transition-transform shadow-[0_0_50px_rgba(0,0,0,1)]" id="workshopModalContent">
            
            <div class="p-5 flex justify-between items-center border-b border-gun-brass/20 shrink-0 bg-gun-metal">
                <div class="flex items-center gap-4">
                    <div class="p-2 border border-gun-brass rounded bg-black/30">
                        <i data-lucide="anvil" class="w-8 h-8 text-gun-brass"></i>
                    </div>
                    <div>
                        <h2 class="font-western text-3xl tracking-widest text-gun-brass">OFICINA DE MANUFATURA</h2>
                        <p class="font-typewriter text-xs text-gun-brass/60 tracking-[0.2em] uppercase">Calculadora de Materiais</p>
                    </div>
                </div>
                <button onclick="toggleWorkshop()" class="hover:text-gun-paper transition-colors text-gun-brass/50"><i data-lucide="x" class="w-8 h-8"></i></button>
            </div>

            <div class="flex flex-col lg:flex-row h-full overflow-hidden relative">
                <!-- Background Texture -->
                <div class="absolute inset-0 pointer-events-none opacity-5 bg-[url('https://www.transparenttextures.com/patterns/aged-paper.png')] z-0"></div>

                <!-- Selection Column -->
                <div class="lg:w-1/2 p-6 flex flex-col border-r border-gun-brass/20 overflow-y-auto custom-scrollbar relative z-10 bg-gun-barrel/50">
                    <div class="mb-6 relative">
                         <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gun-brass/50 w-5 h-5"></i>
                         <input type="text" id="recipeSearch" placeholder="PROCURAR PROJETO..." oninput="renderRecipes(this.value)" class="w-full bg-black/40 border border-gun-brass/30 p-3 pl-10 font-typewriter text-gun-paper focus:outline-none focus:border-gun-brass rounded placeholder-gun-brass/30 uppercase">
                    </div>

                    <div id="recipeList" class="space-y-3 pb-10">
                        <!-- Recipes injected here -->
                    </div>
                </div>

                <!-- Calculation Column -->
                <div class="lg:w-1/2 flex flex-col bg-black/30 relative z-10">
                    <div class="p-6 border-b border-dashed border-gun-brass/20 flex-grow overflow-y-auto custom-scrollbar">
                         <h3 class="font-western text-2xl mb-4 flex items-center gap-2 text-gun-paper"><i data-lucide="clipboard-list" class="w-6 h-6 text-gun-brass"></i> Lista de Produção</h3>
                         <div id="workshopQueue" class="space-y-2 mb-6">
                            <p class="text-gun-paper/30 font-typewriter italic">A fila de produção está vazia.</p>
                         </div>

                         <div class="w-full h-px bg-gun-brass/20 my-6"></div>

                         <h3 class="font-western text-xl mb-4 flex items-center gap-2 text-gun-brass"><i data-lucide="boxes" class="w-5 h-5"></i> Componentes Diretos</h3>
                         <div id="workshopMaterials" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                             <!-- Direct totals injected here -->
                         </div>

                         <div class="bg-black/40 p-4 rounded border border-gun-brass/10">
                             <h3 class="font-western text-xl mb-4 flex items-center gap-2 text-blue-300"><i data-lucide="layers" class="w-5 h-5"></i> Matéria-Prima Total</h3>
                             <p class="text-xs text-gun-paper/50 mb-3 font-typewriter">Recursos base para produzir todos os componentes acima.</p>
                             <div id="workshopRawMaterials" class="grid grid-cols-1 gap-2">
                                 <!-- Raw totals injected here -->
                             </div>
                         </div>
                    </div>
                    
                    <div class="p-4 bg-gun-metal/50 border-t border-gun-brass/20 flex justify-between items-center shrink-0">
                         <button onclick="clearWorkshop()" class="text-xs font-typewriter text-red-400 hover:text-red-300 uppercase tracking-widest flex items-center gap-2 hover:underline">
                             <i data-lucide="trash-2" class="w-4 h-4"></i> Limpar Mesa
                         </button>
                         <div class="font-typewriter text-sm text-gun-paper/60">
                             Total de Itens: <span id="workshopTotalItems" class="text-gun-brass font-bold text-lg">0</span>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GENERIC MESSAGE DIALOG -->
    <div id="genericModal" class="fixed inset-0 bg-black/95 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-md transition-opacity opacity-0 pointer-events-none">
        <div class="bg-gun-paper w-full max-w-md flex flex-col border-[6px] border-double border-gun-barrel relative overflow-hidden transform scale-95 transition-transform" id="genericModalContent">
            <div class="bg-gun-blood p-3 flex justify-between items-center text-white border-b-2 border-black shrink-0">
                <h2 id="genericModalTitle" class="font-western text-xl tracking-widest text-shadow">ALERTA</h2>
                <button onclick="closeGenericModal()" class="hover:text-yellow-400 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 text-center space-y-4 bg-gun-paper">
                <p id="genericModalMessage" class="font-ledger text-lg text-black font-bold"></p>
                <div class="flex justify-center gap-3 mt-4" id="genericModalButtons"></div>
            </div>
        </div>
    </div>

    <script>
        const ICONS_MAP = ['crosshair', 'target', 'shield', 'sword', 'hammer', 'wrench', 'circle-dot', 'triangle', 'square', 'hexagon', 'star', 'skull'];
        const COLORS_MAP = ['#b59b56', '#95a5a6', '#5d4037', '#2c3e50', '#c0392b', '#1a1a1a'];
        
        // Quotes array removed

        const DEFAULT_STORE_NAME = "Black Berets";
        const DEFAULT_STORE_ADDRESS = "Saint Denis, Lemoyne";
        
        const DEFAULT_PRODUCTS = [
            // REVÓLVERES
            { id: '1', name: 'Navy', priceMax: 170.00, priceMin: 120.00, category: 'Revólveres', icon: 'crosshair', color: '#2c3e50' },
            { id: '2', name: 'Lemat', priceMax: 160.00, priceMin: 100.00, category: 'Revólveres', icon: 'crosshair', color: '#1a1a1a' },
            { id: '3', name: 'Vaqueiro', priceMax: 110.00, priceMin: 50.00, category: 'Revólveres', icon: 'crosshair', color: '#95a5a6' },
            { id: '4', name: 'DoubleAction', priceMax: 140.00, priceMin: 80.00, category: 'Revólveres', icon: 'crosshair', color: '#b59b56' },
            { id: '19', name: 'Schofield', priceMax: 150.00, priceMin: 90.00, category: 'Revólveres', icon: 'crosshair', color: '#2c3e50' }, // Restaurado

            // RIFLES & REPETIÇÃO
            { id: '5', name: 'Springfield', priceMax: 280.00, priceMin: 220.00, category: 'Rifles', icon: 'target', color: '#5d4037' },
            { id: '6', name: 'Evans', priceMax: 310.00, priceMin: 250.00, category: 'Rifles', icon: 'target', color: '#1a1a1a' },
            { id: '7', name: 'Carbine', priceMax: 190.00, priceMin: 120.00, category: 'Rifles', icon: 'target', color: '#5d4037' },
            { id: '8', name: 'RollingBlock', priceMax: 600.00, priceMin: 450.00, category: 'Rifles', icon: 'target', color: '#2c3e50' },
            { id: '9', name: 'Winchester', priceMax: 350.00, priceMin: 250.00, category: 'Rifles', icon: 'target', color: '#5d4037' },
            { id: '10', name: 'Ferrolho', priceMax: 350.00, priceMin: 250.00, category: 'Rifles', icon: 'target', color: '#1a1a1a' },
            { id: '20', name: 'Lancaster', priceMax: 240.00, priceMin: 180.00, category: 'Rifles', icon: 'target', color: '#5d4037' }, // Restaurado
            { id: '21', name: 'Litchfield', priceMax: 260.00, priceMin: 190.00, category: 'Rifles', icon: 'target', color: '#5d4037' }, // Restaurado
            { id: '22', name: 'Varmint', priceMax: 180.00, priceMin: 120.00, category: 'Rifles', icon: 'target', color: '#1a1a1a' }, // Restaurado

            // ESCOPETAS (Restaurado Categoria)
            { id: '23', name: 'Pump-Action', priceMax: 200.00, priceMin: 140.00, category: 'Escopetas', icon: 'shield', color: '#2c3e50' },
            { id: '24', name: 'Semi-Auto', priceMax: 280.00, priceMin: 210.00, category: 'Escopetas', icon: 'shield', color: '#1a1a1a' },
            { id: '25', name: 'Cano Duplo', priceMax: 160.00, priceMin: 100.00, category: 'Escopetas', icon: 'shield', color: '#5d4037' },
            { id: '26', name: 'Serrada', priceMax: 130.00, priceMin: 80.00, category: 'Escopetas', icon: 'shield', color: '#5d4037' },

            // PISTOLAS (Restaurado Categoria)
            { id: '27', name: 'Volcanic', priceMax: 150.00, priceMin: 90.00, category: 'Pistolas', icon: 'hexagon', color: '#2c3e50' },
            { id: '28', name: 'Mauser', priceMax: 250.00, priceMin: 180.00, category: 'Pistolas', icon: 'hexagon', color: '#1a1a1a' },
            // Semi Auto removida conforme pedido anterior

            // OUTROS / ACESSÓRIOS
            { id: '12', name: 'Pano de Arma', priceMax: 5.00, priceMin: 5.00, category: 'Outros', icon: 'square', color: '#d8cba8' },
            { id: '29', name: 'Óleo de Arma', priceMax: 5.00, priceMin: 5.00, category: 'Outros', icon: 'wrench', color: '#1a1a1a' }, // Restaurado
            { id: '30', name: 'Arco', priceMax: 140.00, priceMin: 90.00, category: 'Outros', icon: 'star', color: '#5d4037' }, // Restaurado

            // MUNIÇÃO
            { id: '13', name: 'Repetidora', priceMax: 5.50, priceMin: 4.50, category: 'Munição', icon: 'triangle', color: '#b59b56' },
            { id: '14', name: 'Escopeta', priceMax: 6.50, priceMin: 5.50, category: 'Munição', icon: 'shield', color: '#660000' },
            { id: '15', name: 'Pistola', priceMax: 5.10, priceMin: 4.10, category: 'Munição', icon: 'square', color: '#95a5a6' },
            { id: '16', name: 'Revólver', priceMax: 5.10, priceMin: 4.10, category: 'Munição', icon: 'circle-dot', color: '#2c3e50' },
            { id: '17', name: 'Rifle', priceMax: 5.85, priceMin: 4.85, category: 'Munição', icon: 'triangle', color: '#5d4037' },
            { id: '18', name: 'Antipraga', priceMax: 5.20, priceMin: 4.20, category: 'Munição', icon: 'circle-dot', color: '#1a1a1a' },
        ];

        // CRAFTING RECIPES DATABASE (Atualizado com nomes novos)
        const RECIPES = [
            // ARMAS
            { name: "Ferrolho", category: "Armas", materials: { "Rifle Barrel": 1, "Rifle Receiver": 1, "Rifle Stock": 1, "Minério de Aço": 1 } },
            { name: "Carbine", category: "Armas", materials: { "Repeater Barrel": 1, "Repeater Receiver": 1, "Repeater Stock": 1, "Minério de Aço": 1 } },
            { name: "RollingBlock", category: "Armas", materials: { "Rifle Barrel": 1, "Rifle Receiver": 1, "Rifle Stock": 1, "Minério de Aço": 1 } },
            { name: "Lemat", category: "Armas", materials: { "Revolver Barrel": 1, "Revolver Cylinder": 1, "Revolver Handle": 1, "Minério de Aço": 1 } },
            { name: "Springfield", category: "Armas", materials: { "Rifle Barrel": 1, "Rifle Receiver": 1, "Rifle Stock": 1, "Minério de Aço": 1 } },
            { name: "Winchester", category: "Armas", materials: { "Repeater Barrel": 1, "Repeater Receiver": 1, "Repeater Stock": 1, "Minério de Aço": 1 } },
            { name: "Evans", category: "Armas", materials: { "Rifle Barrel": 1, "Rifle Receiver": 1, "Rifle Stock": 1, "Minério de Aço": 1 } },
            { name: "Navy", category: "Armas", materials: { "Revolver Barrel": 1, "Revolver Cylinder": 1, "Revolver Handle": 1, "Minério de Aço": 1 } },
            { name: "Vaqueiro", category: "Armas", materials: { "Revolver Barrel": 1, "Revolver Cylinder": 1, "Revolver Handle": 1, "Minério de Ferro": 1 } },
            { name: "DoubleAction", category: "Armas", materials: { "Revolver Barrel": 1, "Revolver Cylinder": 1, "Revolver Handle": 1, "Minério de Ferro": 1 } },
            { name: "Schofield", category: "Armas", materials: { "Revolver Barrel": 1, "Revolver Cylinder": 1, "Revolver Handle": 1, "Minério de Aço": 1 } },
            { name: "Lancaster", category: "Armas", materials: { "Repeater Barrel": 1, "Repeater Receiver": 1, "Repeater Stock": 1, "Minério de Aço": 1 } },
            { name: "Pump-Action", category: "Armas", materials: { "Shotgun Barrel": 1, "Shotgun Receiver": 1, "Shotgun Stock": 1, "Minério de Aço": 1 } },
            { name: "Serrada", category: "Armas", materials: { "Shotgun Barrel": 1, "Shotgun Receiver": 1, "Shotgun Grip": 1, "Minério de Ferro": 1 } },
            { name: "Volcanic", category: "Armas", materials: { "Pistol Barrel": 1, "Pistol Receiver": 1, "Pistol Grip": 1, "Minério de Ferro": 1 } },
            { name: "Mauser", category: "Armas", materials: { "Pistol Barrel": 1, "Pistol Slide": 1, "Pistol Grip": 1, "Minério de Aço": 1 } },
            
            // COMPONENTES
            { name: "Revolver Cylinder", category: "Componentes", materials: { "Barra de Ferro": 2 } },
            { name: "Revolver Handle", category: "Componentes", materials: { "Madeira": 2 } },
            { name: "Revolver Barrel", category: "Componentes", materials: { "Barra de Ferro": 2 } },
            { name: "Rifle Receiver", category: "Componentes", materials: { "Barra de Ferro": 3 } },
            { name: "Rifle Barrel", category: "Componentes", materials: { "Barra de Aço": 3 } },
            { name: "Rifle Stock", category: "Componentes", materials: { "Madeira": 3 } },
            { name: "Repeater Barrel", category: "Componentes", materials: { "Barra de Ferro": 2 } },
            { name: "Repeater Receiver", category: "Componentes", materials: { "Barra de Ferro": 2 } },
            { name: "Repeater Stock", category: "Componentes", materials: { "Madeira": 2 } },
            
            // MUNIÇÃO
            { name: "Repetidora", category: "Munição", materials: { "Minério de Ferro": 5, "Pólvora": 3 } },
            { name: "Rifle", category: "Munição", materials: { "Minério de Ferro": 8, "Pólvora": 5 } },
            { name: "Escopeta", category: "Munição", materials: { "Minério de Ferro": 6, "Pólvora": 6 } },
            { name: "Revólver", category: "Munição", materials: { "Minério de Ferro": 5, "Pólvora": 3 } },
            { name: "Pistola", category: "Munição", materials: { "Minério de Ferro": 5, "Pólvora": 3 } },
            
            // OUTROS
            { name: "Pano de Arma", category: "Outros", materials: { "Algodão": 5 } },
            { name: "Óleo de Arma", category: "Outros", materials: { "Gordura Animal": 2 } }
        ];

        let state = {
            storeName: DEFAULT_STORE_NAME,
            storeAddress: DEFAULT_STORE_ADDRESS,
            products: JSON.parse(JSON.stringify(DEFAULT_PRODUCTS)),
            cart: {}, // Structure now: { id: { qty: 1, useMin: false } }
            logo: null,
            showHeader: true,
            showWatermark: true
            // Removed serviceMode/Value as it is now dynamic based on cart items
        };

        // Workshop State
        let workshopQueue = {}; 

        let tempIcon = 'crosshair';
        let tempColor = '#b59b56';

        // --- Generic Dialog Logic ---
        function showDialog({ title, message, type = 'alert', onConfirm }) {
            const modal = document.getElementById('genericModal');
            const content = document.getElementById('genericModalContent');
            const titleEl = document.getElementById('genericModalTitle');
            const msgEl = document.getElementById('genericModalMessage');
            const btnContainer = document.getElementById('genericModalButtons');

            titleEl.innerText = title || (type === 'confirm' ? 'CONFIRMAÇÃO' : 'ATENÇÃO');
            msgEl.innerText = message;
            btnContainer.innerHTML = '';

            if (type === 'confirm') {
                const cancelBtn = document.createElement('button');
                cancelBtn.className = "px-4 py-2 font-western text-black border border-black/20 hover:bg-black/10 rounded transition-colors uppercase";
                cancelBtn.innerText = "Cancelar";
                cancelBtn.onclick = closeGenericModal;
                btnContainer.appendChild(cancelBtn);

                const confirmBtn = document.createElement('button');
                confirmBtn.className = "bg-gun-blood text-white px-6 py-2 font-western uppercase rounded shadow-lg hover:bg-red-900 border border-black transition-transform hover:scale-105";
                confirmBtn.innerText = "Confirmar";
                confirmBtn.onclick = () => {
                    if (onConfirm) onConfirm();
                    closeGenericModal();
                };
                btnContainer.appendChild(confirmBtn);
            } else {
                const okBtn = document.createElement('button');
                okBtn.className = "bg-gun-barrel text-gun-brass px-6 py-2 font-western uppercase rounded shadow-lg hover:bg-black border border-gun-brass transition-transform hover:scale-105";
                okBtn.innerText = "Entendido";
                okBtn.onclick = closeGenericModal;
                btnContainer.appendChild(okBtn);
            }

            modal.classList.remove('hidden');
            void modal.offsetWidth;
            modal.classList.remove('opacity-0', 'pointer-events-none');
            content.classList.remove('scale-95');
            content.classList.add('scale-100');
        }

        function closeGenericModal() {
            const modal = document.getElementById('genericModal');
            const content = document.getElementById('genericModalContent');
            
            modal.classList.add('opacity-0', 'pointer-events-none');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        // -----------------------------

        function init() {
            const saved = localStorage.getItem('gunsmith_ledger_v2'); // New version key to force reset
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed };
                    if(!state.storeAddress) state.storeAddress = DEFAULT_STORE_ADDRESS;
                } catch(e) { console.error("Save corrupted", e); }
            }

            document.getElementById('receiptAddressDate').innerText = state.storeAddress;
            // Quote display logic removed

            setupPickers();
            renderAll();
            renderRecipes(); 
        }

        function renderAll() {
            renderHeader();
            renderProducts();
            // renderServiceControls(); // Removed as it is replaced by static HTML logic
            renderReceipt();
            if (window.lucide) {
                lucide.createIcons();
            }
        }

        function renderHeader() {
            document.getElementById('headerStoreName').innerText = state.storeName;
            
            const logoContainer = document.getElementById('headerLogoContainer');
            if (state.logo && state.showHeader) {
                logoContainer.innerHTML = `<img src="${state.logo}" class="w-full h-full object-cover grayscale contrast-125">`;
                logoContainer.classList.remove('hidden');
                logoContainer.classList.add('flex'); // Garante que apareça se houver logo
            } else {
                logoContainer.innerHTML = '';
                logoContainer.classList.add('hidden');
                logoContainer.classList.remove('flex');
            }
        }

        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '';
            
            const categories = ['Revólveres', 'Rifles', 'Escopetas', 'Pistolas', 'Munição', 'Outros'];
            const iconsMap = { 
                'Revólveres': 'crosshair', 
                'Rifles': 'target', 
                'Escopetas': 'shield',
                'Pistolas': 'hexagon', 
                'Munição': 'circle-dot', 
                'Outros': 'square'
            };

            categories.forEach(cat => {
                // Filter out 'Personalização' items from the grid display so they don't clutter it
                const prods = state.products.filter(p => p.category === cat && p.category !== 'Personalização');
                if (prods.length === 0) return;

                const catHeader = document.createElement('h3');
                catHeader.className = "font-western text-xl text-gun-brass border-b border-gun-brass/20 mb-4 mt-6 pb-1 uppercase tracking-widest flex items-center gap-2 select-none shadow-black drop-shadow-md";
                catHeader.innerHTML = `<i data-lucide="${iconsMap[cat] || 'box'}" class="w-5 h-5"></i> ${cat}`;
                grid.appendChild(catHeader);

                const divGrid = document.createElement('div');
                divGrid.className = "grid grid-cols-1 md:grid-cols-2 gap-4";
                
                prods.forEach(p => {
                    // Check cart state for this item
                    const cartItem = state.cart[p.id];
                    const qty = cartItem ? cartItem.qty : 0;
                    const isSelected = qty > 0;
                    
                    const card = document.createElement('div');
                    card.className = `relative p-4 border transition-all duration-300 cursor-pointer select-none rounded group overflow-hidden ${isSelected ? 'bg-gun-metal border-gun-brass shadow-[0_0_15px_rgba(181,155,86,0.2)]' : 'bg-black/40 border-gun-brass/20 hover:border-gun-brass/50'}`;
                    // Clicking card adds 1 to Max price by default
                    card.onclick = () => updateCart(p.id, 1);

                    const corners = `
                        <div class="absolute top-1 left-1 w-1 h-1 rounded-full bg-gun-brass/30"></div>
                        <div class="absolute top-1 right-1 w-1 h-1 rounded-full bg-gun-brass/30"></div>
                        <div class="absolute bottom-1 left-1 w-1 h-1 rounded-full bg-gun-brass/30"></div>
                        <div class="absolute bottom-1 right-1 w-1 h-1 rounded-full bg-gun-brass/30"></div>
                    `;

                    // Format Price Display Range
                    let priceDisplay = `$${p.priceMax.toFixed(2)}`;
                    if(p.priceMin && p.priceMin < p.priceMax) {
                        priceDisplay = `<span class="text-green-500/80">$${p.priceMin.toFixed(2)}</span> <span class="text-xs opacity-40 mx-1">à</span> <span class="text-sm opacity-60">$${p.priceMax.toFixed(2)}</span>`;
                    }

                    // Format Name for Ammo
                    let displayName = p.name;
                    if(p.category === 'Munição') {
                        displayName += ` 1cx <span class="text-[0.6rem] tracking-tighter opacity-70 ml-1">(25un)</span>`;
                    }

                    card.innerHTML = `
                        ${corners}
                        <div class="flex items-center space-x-3 mb-4 relative z-10">
                           <div class="p-2 rounded bg-black/50 border border-gun-brass/10 transition-colors">
                             <i data-lucide="${p.icon || 'crosshair'}" style="color: ${p.color || '#b59b56'}" class="w-6 h-6"></i>
                           </div>
                           <h3 class="font-western text-lg leading-none text-gun-paper tracking-wide pt-1 drop-shadow-md flex items-baseline">${displayName}</h3>
                        </div>
                        <div class="flex justify-between items-end relative z-10">
                            <div class="font-typewriter font-bold text-gun-brass flex items-center">${priceDisplay}</div>
                            
                            <div class="flex items-center space-x-1 bg-black p-1 rounded border border-gun-brass/20" onclick="event.stopPropagation()">
                                <button onclick="updateCart('${p.id}', -1)" class="w-8 h-8 flex items-center justify-center bg-gun-blood text-white rounded-sm hover:bg-red-900 border border-black shadow-sm disabled:opacity-50 disabled:grayscale transition-colors" ${qty === 0 ? 'disabled' : ''}><i data-lucide="minus" class="w-4 h-4"></i></button>
                                <span class="font-typewriter text-xl font-bold w-10 text-center text-gun-paper">${qty > 0 ? qty : ''}</span>
                                <button onclick="updateCart('${p.id}', 1)" class="w-8 h-8 flex items-center justify-center bg-gun-brass text-black rounded-sm hover:bg-yellow-600 border border-black shadow-sm transition-colors"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    `;
                    divGrid.appendChild(card);
                });
                grid.appendChild(divGrid);
            });
        }

        function addCustomization() {
            const input = document.getElementById('customizationInput');
            const value = parseFloat(input.value);
            
            if (!value || value <= 0) {
                showDialog({ title: 'Atenção', message: "Insira um valor válido para a personalização." });
                return;
            }

            const customId = `cust_${Date.now()}`;
            
            // Add temporary product to state
            state.products.push({
                id: customId,
                name: 'Personalização de arma',
                priceMax: value,
                priceMin: value, // Fixed price for custom entry
                category: 'Personalização',
                icon: 'hammer',
                color: '#b59b56',
                isTemp: true
            });

            // Add to cart
            state.cart[customId] = { qty: 1, useMin: false };
            
            input.value = '';
            saveState();
            renderAll();
        }

        function renderReceipt() {
            const subtotalEl = document.getElementById('subtotalDisplay');
            const serviceDisplayEl = document.getElementById('serviceDisplay');
            const serviceLabelEl = document.getElementById('serviceLabel');
            const totalEl = document.getElementById('totalDisplay');
            const container = document.getElementById('cartItems');

            document.getElementById('receiptStoreTitle').innerText = state.storeName;
            document.getElementById('receiptAddressDate').innerText = state.storeAddress;
            
            const receiptLogo = document.getElementById('receiptLogo');
            const watermark = document.getElementById('receiptWatermark');

            if (state.logo && state.showHeader) {
                receiptLogo.src = state.logo;
                receiptLogo.classList.remove('hidden');
            } else receiptLogo.classList.add('hidden');

            if (state.logo && state.showWatermark) {
                watermark.querySelector('img').src = state.logo;
                watermark.classList.remove('hidden');
            } else watermark.classList.add('hidden');

            let subtotal = 0;
            let customizationTotal = 0; // Track total value of customizations for 30% fee
            let html = `
                <table class="w-full text-left font-typewriter text-sm">
                    <thead><tr class="border-b border-gray-400 text-gray-500 text-[10px] tracking-wider"><th class="pb-1 w-8">QTD</th><th class="pb-1">ITEM</th><th class="pb-1 text-right">VALOR</th></tr></thead>
                    <tbody class="divide-y divide-gray-300/50">
            `;
            
            let hasItems = false;
            Object.entries(state.cart).forEach(([id, item]) => {
                if (item.qty > 0) {
                    hasItems = true;
                    const prod = state.products.find(p => p.id === id);
                    if (prod) {
                        // Determine price based on 'useMin' flag
                        const currentPrice = item.useMin ? prod.priceMin : prod.priceMax;
                        const total = currentPrice * item.qty;
                        subtotal += total;

                        // Calculate customization base for service fee
                        if (prod.category === 'Personalização') {
                            customizationTotal += total;
                        }

                        // Discount toggle button style
                        let discBtn = '';
                        // Only show Min/Max toggle if prices differ and not a custom item
                        if (prod.priceMin !== prod.priceMax) {
                             const discBtnClass = item.useMin 
                                ? "text-[9px] bg-green-800 text-white px-1 rounded ml-2 cursor-pointer hover:bg-green-700" 
                                : "text-[9px] bg-gray-300 text-gray-600 px-1 rounded ml-2 cursor-pointer hover:bg-gray-400";
                             const discBtnText = item.useMin ? "MÍN" : "MÁX";
                             discBtn = `<button onclick="toggleItemPrice('${id}')" class="${discBtnClass}" title="Alternar Preço Máximo/Mínimo">${discBtnText}</button>`;
                        }

                        // Name format for receipt
                        let receiptName = prod.name;
                        if(prod.category === 'Munição') receiptName += ' 1cx';

                        html += `
                        <tr class="group">
                            <td class="py-2 font-bold align-top text-gray-800">${item.qty}</td>
                            <td class="py-2 align-top leading-tight text-gray-900">
                                <div class="flex items-center">
                                    <span class="uppercase">${receiptName}</span>
                                    ${discBtn}
                                </div>
                                <div class="text-[9px] text-gray-500">${prod.category}</div>
                            </td>
                            <td class="py-2 text-right align-top whitespace-nowrap text-gray-900 font-bold">$${total.toFixed(2)}</td>
                        </tr>`;
                    }
                }
            });
            html += '</tbody></table>';

            if (!hasItems) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-40 text-gray-400 italic font-western"><i data-lucide="scroll" class="w-8 h-8 mb-2 opacity-50"></i><span>Nenhum pedido anotado...</span></div>`;
            } else {
                container.innerHTML = html;
            }

            // Calculation Logic
            // Service fee is ALWAYS 30% of customization total
            const serviceAmount = customizationTotal * 0.30;
            const serviceLabelText = serviceAmount > 0 ? "MÃO DE OBRA (30%):" : "TAXA DE SERVIÇO:";

            const finalTotal = subtotal + serviceAmount;

            subtotalEl.innerText = `$${subtotal.toFixed(2)}`;
            serviceLabelEl.innerText = serviceLabelText;
            serviceDisplayEl.innerText = `+ $${serviceAmount.toFixed(2)}`;
            totalEl.innerText = `$${finalTotal.toFixed(2)}`;
        }

        function updateCart(id, change) {
            if (!state.cart[id]) {
                // Initialize item in cart (default to Max Price)
                state.cart[id] = { qty: 0, useMin: false };
            }
            
            state.cart[id].qty += change;
            
            if (state.cart[id].qty <= 0) {
                delete state.cart[id];
            }
            
            saveState();
            renderAll();
        }

        function toggleItemPrice(id) {
            if (state.cart[id]) {
                state.cart[id].useMin = !state.cart[id].useMin;
                saveState();
                renderAll();
            }
        }

        function clearCart() {
            if(Object.keys(state.cart).length > 0) {
                 const paper = document.getElementById('receiptArea');
                 paper.style.transition = 'transform 0.2s';
                 paper.style.transform = 'scale(0.95) rotate(1deg)';
                 
                 setTimeout(() => {
                     // Filter out temporary customization items from products array to clean up memory
                     state.products = state.products.filter(p => !p.isTemp);
                     
                     state.cart = {};
                     // state.serviceMode/Value removed
                     
                     saveState();
                     renderAll();
                     paper.style.transform = 'rotate(0.5deg)'; 
                 }, 200);
            }
        }

        function downloadReceipt() {
            const element = document.getElementById('receiptArea');
            // Temporarily remove shadow for cleaner image
            const originalShadow = element.style.boxShadow;
            element.style.boxShadow = 'none';

            html2canvas(element, { 
                scale: 2, 
                backgroundColor: null, // Transparent background outside the receipt
                useCORS: true, 
                ignoreElements: (el) => el.getAttribute('data-html2canvas-ignore') === 'true' 
            })
            .then(canvas => {
                element.style.boxShadow = originalShadow;
                const link = document.createElement('a');
                const safeName = state.storeName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                link.download = `recibo_${safeName}_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(err => {
                element.style.boxShadow = originalShadow;
                showDialog({ title: 'Erro', message: "Erro ao gerar imagem: " + err });
            });
        }

        function saveState() {
            localStorage.setItem('gunsmith_ledger_v2', JSON.stringify(state));
        }

        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            const content = document.getElementById('settingsModalContent');
            const isHidden = modal.classList.contains('hidden');
            
            if (isHidden) {
                modal.classList.remove('hidden');
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0', 'pointer-events-none');
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                });
                document.getElementById('confStoreName').value = state.storeName;
                document.getElementById('confStoreAddress').value = state.storeAddress;
                document.getElementById('confShowHeader').checked = state.showHeader;
                document.getElementById('confShowWatermark').checked = state.showWatermark;
                document.getElementById('prodCount').innerText = state.products.length;
                if(state.logo) {
                    document.getElementById('confLogoPreview').src = state.logo;
                    document.getElementById('confLogoPreview').classList.remove('hidden');
                    document.getElementById('confLogoPlaceholder').classList.add('hidden');
                } else {
                    document.getElementById('confLogoPreview').classList.add('hidden');
                    document.getElementById('confLogoPlaceholder').classList.remove('hidden');
                }
                switchTab('general');
                renderConfProductList();
            } else {
                modal.classList.add('opacity-0', 'pointer-events-none');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        function switchTab(tabName) {
            ['general', 'products'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                const div = document.getElementById(`content-${t}`);
                if (t === tabName) {
                    btn.classList.add('bg-gun-barrel', 'text-gun-brass', 'border-r', 'border-l', 'border-t', 'border-b-0', 'border-gun-brass/20', 'font-bold');
                    btn.classList.remove('text-gun-paper/40', 'hover:bg-gun-brass/5');
                    div.classList.remove('hidden');
                } else {
                    btn.classList.remove('bg-gun-barrel', 'text-gun-brass', 'border-r', 'border-l', 'border-t', 'border-b-0', 'font-bold');
                    btn.classList.add('text-gun-paper/40', 'hover:bg-gun-brass/5');
                    div.classList.add('hidden');
                }
            });
        }

        function setupPickers() {
            const iconGrid = document.getElementById('iconPickerGrid');
            iconGrid.innerHTML = '';
            ICONS_MAP.forEach(icon => {
                const btn = document.createElement('button');
                btn.className = "icon-btn w-10 h-10 flex items-center justify-center rounded border border-transparent hover:bg-gun-brass/10 transition-all text-gun-brass/60";
                btn.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i>`;
                btn.onclick = () => selectIcon(btn, icon);
                if(icon === tempIcon) btn.classList.add('selected');
                iconGrid.appendChild(btn);
            });

            const colorGrid = document.getElementById('colorPickerGrid');
            colorGrid.innerHTML = '';
            COLORS_MAP.forEach(color => {
                const btn = document.createElement('button');
                btn.className = "color-btn w-8 h-8 rounded-full border-2 border-transparent transition-all shadow-sm";
                btn.style.backgroundColor = color;
                btn.onclick = () => selectColor(btn, color);
                if(color === tempColor) {
                    btn.classList.add('selected');
                    btn.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-white mx-auto drop-shadow-md"></i>';
                }
                colorGrid.appendChild(btn);
            });
        }

        function selectIcon(btn, icon) {
            tempIcon = icon;
            document.querySelectorAll('.icon-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            if(window.lucide) lucide.createIcons();
        }

        function selectColor(btn, color) {
            tempColor = color;
            document.querySelectorAll('.color-btn').forEach(b => {
                b.classList.remove('selected');
                b.innerHTML = '';
            });
            btn.classList.add('selected');
            btn.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-white mx-auto drop-shadow-md"></i>';
            if(window.lucide) lucide.createIcons();
        }

        function addProduct() {
            const name = document.getElementById('newProdName').value;
            const priceMax = parseFloat(document.getElementById('newProdPriceMax').value);
            const cat = document.getElementById('newProdCat').value;
            
            // Default min price to same as max if not provided in simple add mode, 
            // or we could add a secondary input. For simplicity in "Quick Add", we assume fixed price.
            // If user wants specific range, they should edit in JSON or we add a field.
            // Let's assume priceMax is the main price.
            
            if (name && !isNaN(priceMax)) {
                state.products.push({ 
                    id: `gun_${Date.now()}`, 
                    name, 
                    priceMax, 
                    priceMin: priceMax, // Default same
                    category: cat, 
                    icon: tempIcon, 
                    color: tempColor 
                });
                document.getElementById('newProdName').value = '';
                document.getElementById('newProdPriceMax').value = '';
                document.getElementById('prodCount').innerText = state.products.length;
                renderConfProductList();
                renderAll(); 
            } else {
                showDialog({ title: 'Erro', message: "Informe o nome e o preço da arma." });
            }
        }

        function renderConfProductList() {
            const list = document.getElementById('confProductList');
            list.innerHTML = '';
            if (state.products.length === 0) {
                list.innerHTML = '<p class="text-center text-gun-brass/30 py-4 font-typewriter">Estoque vazio.</p>';
                return;
            }

            state.products.forEach((p, index) => {
                const item = document.createElement('div');
                item.className = "flex items-center gap-3 p-3 bg-black/40 rounded border border-gun-brass/10 hover:border-gun-brass/30 transition-colors";
                item.innerHTML = `
                    <div class="p-2 rounded bg-black border border-gun-brass/10"><i data-lucide="${p.icon || 'crosshair'}" style="color:${p.color || '#b59b56'}" class="w-4 h-4"></i></div>
                    <div class="flex-1 font-typewriter"><div class="font-bold text-gun-paper">${p.name}</div><div class="text-[10px] opacity-60 uppercase text-gun-brass">${p.category}</div></div>
                    <div class="font-bold text-gun-brass font-typewriter text-lg">$${p.priceMax.toFixed(2)}</div>
                    <button onclick="removeProduct(${index})" class="p-2 text-gun-paper/40 hover:text-red-500 hover:bg-red-900/20 rounded transition-colors" title="Excluir"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                `;
                list.appendChild(item);
            });
            if(window.lucide) lucide.createIcons();
        }

        function removeProduct(index) {
            showDialog({
                type: 'confirm',
                title: 'Remover Arma',
                message: 'Retirar este item do catálogo permanentemente?',
                onConfirm: () => {
                      const prodId = state.products[index].id;
                      state.products.splice(index, 1);
                      if(state.cart[prodId]) delete state.cart[prodId];
                      document.getElementById('prodCount').innerText = state.products.length;
                      renderConfProductList();
                      renderAll();
                }
            });
        }

        function handleLogoUpload(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    state.logo = e.target.result;
                    document.getElementById('confLogoPreview').src = state.logo;
                    document.getElementById('confLogoPreview').classList.remove('hidden');
                    document.getElementById('confLogoPlaceholder').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function removeLogo() {
            state.logo = null;
            document.getElementById('confLogoPreview').classList.add('hidden');
            document.getElementById('confLogoPlaceholder').classList.remove('hidden');
            document.getElementById('logoInput').value = "";
        }

        function exportSettings() {
            const blob = new Blob([JSON.stringify(state, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gunsmith_inventory_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importSettingsClick() {
            document.getElementById('importInput').click();
        }

        function importSettings(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    showDialog({
                        type: 'confirm',
                        title: 'Importar Inventário',
                        message: "Isso substituirá seu estoque atual. Continuar?",
                        onConfirm: () => {
                             state = { ...state, ...data };
                             saveState();
                             toggleSettings();
                             renderAll();
                             showDialog({ title: 'Sucesso', message: "Inventário atualizado." });
                        }
                    });
                } catch(err) { showDialog({ title: 'Erro', message: "Arquivo inválido!" }); }
                input.value = ''; 
            }
            reader.readAsText(file);
        }

        function resetFactory() {
            showDialog({
                type: 'confirm',
                title: 'Reiniciar Tudo',
                message: "Apagar todos os dados personalizados e armas criadas?",
                onConfirm: () => {
                      localStorage.removeItem('gunsmith_ledger_v2');
                      location.reload();
                }
            });
        }
        
        function saveSettings() {
            state.storeName = document.getElementById('confStoreName').value;
            state.storeAddress = document.getElementById('confStoreAddress').value;
            state.showHeader = document.getElementById('confShowHeader').checked;
            state.showWatermark = document.getElementById('confShowWatermark').checked;
            saveState();
            toggleSettings();
            renderAll();
        }

        // ============================================
        // WORKSHOP / CRAFTING LOGIC
        // ============================================

        function toggleWorkshop() {
            const modal = document.getElementById('workshopModal');
            const content = document.getElementById('workshopModalContent');
            const isHidden = modal.classList.contains('hidden');

            if (isHidden) {
                modal.classList.remove('hidden');
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0', 'pointer-events-none');
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                });
                renderRecipes();
                renderWorkshopQueue();
            } else {
                modal.classList.add('opacity-0', 'pointer-events-none');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        function renderRecipes(filter = "") {
            const list = document.getElementById('recipeList');
            list.innerHTML = '';

            const filtered = RECIPES.filter(r => r.name.toLowerCase().includes(filter.toLowerCase()));

            if (filtered.length === 0) {
                list.innerHTML = '<p class="text-gun-paper/30 italic text-center py-4 font-typewriter">Nenhum projeto encontrado.</p>';
                return;
            }

            // Group by Category
            const categories = {};
            filtered.forEach(r => {
                if(!categories[r.category]) categories[r.category] = [];
                categories[r.category].push(r);
            });

            Object.entries(categories).forEach(([cat, recipes]) => {
                const catHeader = document.createElement('h4');
                catHeader.className = "text-gun-brass/70 font-western border-b border-gun-brass/10 mt-4 mb-2 uppercase tracking-widest text-sm";
                catHeader.innerText = cat;
                list.appendChild(catHeader);

                recipes.forEach(r => {
                    const el = document.createElement('div');
                    el.className = "flex justify-between items-center p-3 bg-black/40 hover:bg-black/60 border border-gun-brass/10 hover:border-gun-brass/40 rounded group cursor-pointer transition-all";
                    el.onclick = () => addToWorkshop(r.name);

                    // Material Preview
                    const matsPreview = Object.entries(r.materials).map(([k,v]) => `${v}x ${k}`).join(', ');

                    el.innerHTML = `
                        <div>
                            <div class="font-typewriter font-bold text-gun-paper group-hover:text-gun-brass transition-colors">${r.name}</div>
                            <div class="text-[10px] text-gun-paper/40 uppercase tracking-wide group-hover:text-gun-paper/60">${matsPreview}</div>
                        </div>
                        <div class="p-2 bg-gun-metal rounded group-hover:bg-gun-brass group-hover:text-black transition-colors text-gun-brass shadow-sm">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </div>
                    `;
                    list.appendChild(el);
                });
            });
            if(window.lucide) lucide.createIcons();
        }

        function addToWorkshop(itemName) {
            if (!workshopQueue[itemName]) workshopQueue[itemName] = 0;
            workshopQueue[itemName]++;
            renderWorkshopQueue();
            calculateMaterials();
        }

        function removeFromWorkshop(itemName) {
            if (workshopQueue[itemName]) {
                workshopQueue[itemName]--;
                if(workshopQueue[itemName] <= 0) delete workshopQueue[itemName];
                renderWorkshopQueue();
                calculateMaterials();
            }
        }

        function renderWorkshopQueue() {
            const queueDiv = document.getElementById('workshopQueue');
            const totalSpan = document.getElementById('workshopTotalItems');
            
            queueDiv.innerHTML = '';
            let total = 0;

            if (Object.keys(workshopQueue).length === 0) {
                queueDiv.innerHTML = '<p class="text-gun-paper/30 font-typewriter italic text-center py-4">Selecione projetos à esquerda para começar.</p>';
                totalSpan.innerText = "0";
                calculateMaterials(); // Clear lists
                return;
            }

            Object.entries(workshopQueue).forEach(([name, qty]) => {
                total += qty;
                const el = document.createElement('div');
                el.className = "flex justify-between items-center p-2 bg-black/20 border-l-4 border-gun-brass";
                el.innerHTML = `
                    <div class="font-typewriter text-gun-paper">${name}</div>
                    <div class="flex items-center gap-3">
                        <button onclick="removeFromWorkshop('${name}')" class="text-gun-paper/40 hover:text-red-400 transition-colors"><i data-lucide="minus-circle" class="w-5 h-5"></i></button>
                        <span class="font-bold text-lg w-6 text-center text-gun-brass font-western">${qty}</span>
                        <button onclick="addToWorkshop('${name}')" class="text-gun-paper/40 hover:text-green-400 transition-colors"><i data-lucide="plus-circle" class="w-5 h-5"></i></button>
                    </div>
                `;
                queueDiv.appendChild(el);
            });
            totalSpan.innerText = total;
            if(window.lucide) lucide.createIcons();
        }

        // Recursive function to break down materials
        function getRawIngredients(itemName, quantity, rawTotals) {
            const recipe = RECIPES.find(r => r.name === itemName);
            
            if (recipe) {
                // If it has a recipe, recurse deeper
                Object.entries(recipe.materials).forEach(([matName, matQty]) => {
                    getRawIngredients(matName, matQty * quantity, rawTotals);
                });
            } else {
                // If no recipe, it is a raw material
                if (!rawTotals[itemName]) rawTotals[itemName] = 0;
                rawTotals[itemName] += quantity;
            }
        }

        function calculateMaterials() {
            const matsDiv = document.getElementById('workshopMaterials');
            const rawMatsDiv = document.getElementById('workshopRawMaterials');
            
            const directAggregates = {};
            const rawAggregates = {};

            // 1. Calculate Direct Materials
            Object.entries(workshopQueue).forEach(([name, qty]) => {
                const recipe = RECIPES.find(r => r.name === name);
                if (recipe) {
                    Object.entries(recipe.materials).forEach(([matName, matQty]) => {
                        if (!directAggregates[matName]) directAggregates[matName] = 0;
                        directAggregates[matName] += (matQty * qty);
                    });
                    
                    // 2. Calculate Raw Materials Recursively
                    getRawIngredients(name, qty, rawAggregates);
                }
            });

            // Render Direct
            matsDiv.innerHTML = '';
            if (Object.keys(directAggregates).length === 0) {
                matsDiv.innerHTML = '<div class="col-span-2 text-center text-gun-paper/30 italic font-typewriter">Nenhum componente necessário.</div>';
            } else {
                Object.entries(directAggregates).forEach(([mat, count]) => {
                    const el = document.createElement('div');
                    el.className = "flex justify-between items-center p-2 bg-black/40 border border-gun-brass/10 rounded shadow-sm";
                    el.innerHTML = `
                        <span class="text-gun-paper/80 font-typewriter text-xs uppercase tracking-wide">${mat}</span>
                        <span class="text-gun-brass font-bold font-western text-md drop-shadow-sm">${count}x</span>
                    `;
                    matsDiv.appendChild(el);
                });
            }

            // Render Raw
            rawMatsDiv.innerHTML = '';
            if (Object.keys(rawAggregates).length === 0) {
                rawMatsDiv.innerHTML = '<div class="text-center text-gun-paper/30 italic font-typewriter text-xs">Nenhuma matéria-prima.</div>';
            } else {
                // Sort alphabetically for easier reading
                Object.entries(rawAggregates).sort().forEach(([mat, count]) => {
                    const el = document.createElement('div');
                    el.className = "flex justify-between items-center p-2 border-b border-white/5 last:border-0";
                    el.innerHTML = `
                        <span class="text-blue-200/80 font-typewriter text-sm uppercase tracking-wider pl-2 flex items-center gap-2"><div class="w-1 h-1 bg-blue-400 rounded-full"></div> ${mat}</span>
                        <span class="text-blue-300 font-bold font-typewriter text-md">${count}x</span>
                    `;
                    rawMatsDiv.appendChild(el);
                });
            }
        }

        function clearWorkshop() {
            workshopQueue = {};
            renderWorkshopQueue();
            // calculateMaterials is called inside renderWorkshopQueue when empty
        }

        init();
    </script>
</body>
</html>
